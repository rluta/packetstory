var width=960,height=500;PacketStory={charts:{spec:{},data:{}},init:function(){PacketStory.initSemanticModules(),PacketStory.initBehaviors(),PacketStory.initTcpChat(),PacketStory.initBwlat(),PacketStory.initTtl(),PacketStory.initLargePacket()},initSemanticModules:function(){$(".ui.accordion").accordion()},initBehaviors:function(){$("section[data-tabular]").each(function(a){$("[data-tab]",a).click(function(){$("[data-tab]",a).removeClass("active"),$(this).addClass("active");var b=$(this).data("tab");$(".tab",a).hide(),$("#"+b).show()}),$("[data-tab]:first",a).click()})},initTcpChat:function(){$(".message-wrapper .fragment").watch("className",function(){var a=$(this).data("flag-before"),b=$(this).data("flag-after"),c=$(this).hasClass("to")?"sender":"recipient",d=$(this).data("sender-state"),e=$(this).data("recipient-state");$(this).hasClass("visible")?(a&&$("#"+c+"-state").append('<div data-flag="'+a+'" class="item flag before">'+a+"</div>"),d&&$("#sender-state").append('<div data-state="'+d+'" class="item state">'+d+"</div>"),e&&$("#recipient-state").append('<div data-state="'+e+'" class="item state">'+e+"</div>"),b&&$("#"+c+"-state").append('<div data-flag="'+b+'" class="item flag after">'+b+"</div>")):(a&&$("#"+c+'-state [data-flag="'+a+'"]').remove(),b&&$("#"+c+'-state [data-flag="'+b+'"]').remove(),d&&$('#sender-state [data-state="'+d+'"]').remove(),e&&$('#recipient-state [data-state="'+e+'"]').remove())})},initBwlat:function(){$("#bwlat-toolbars .button:not(.disabled)").on("click",function(){var a=$(this).text().toLowerCase();$("#bwlat-toolbars .button:not(.disabled)").removeClass("active"),$(this).addClass("active");var b=PacketStory.charts.spec.bwlat;for(var c in b.scales){var d=b.scales[c];0==d.name.indexOf("y")&&(d.type=a)}vg.parse.spec(b,function(a){PacketStory.charts.bwlat=a({el:"#bwlat_chart"}).update()})}),$("#bwlat-toolbars .item:not(.disabled)").on("click",function(){var a=$(this).data("source");$("#bwlat-toolbars .item:not(.disabled)").removeClass("active"),$(this).addClass("active"),d3.json(a,function(a,b){PacketStory.charts.spec.bwlat=b,$("#bwlat-toolbars .button.active").click()})}),$("#bwlat-toolbars .item.active").click()},initTtl:function(){d3.json(TTLChart.chartUrl,function(a,b){TTLChart.spec=b,TTLChart.addNetwork("adsl"),TTLChart.updateView(),TTLChart.updateModel(),vg.parse.spec(TTLChart.spec,function(a){TTLChart.chart=a({data:TTLChart.data,el:"#ttl-chart"}).update()})}),$("[data-property]").drag("start",function(){var a=($(this).data("property"),$(this).closest("[data-net]").data("net")),b=TTLChart.selectedNets[a],c={id:b.id+"drag"};for(var d in b)"id"!=d&&(c[d]=b[d]);TTLChart.selectedNets.push(c)}).drag(function(a,b){var c=$(this).data("property"),d=TTLChart.selectedNets[TTLChart.selectedNets.length-1];d[c]=TTLChart.updateValue(a,b,d[c],$(this).data("min"),$(this).data("max"),$(this).data("step")),$(this).text(d[c]),TTLChart.update()}).drag("end",function(){var a=$(this).data("property"),b=$(this).closest("[data-net]").data("net"),c=TTLChart.selectedNets[TTLChart.selectedNets.length-1],d=TTLChart.selectedNets[b];for(var e in d)"id"!=e&&(d[e]=c[e]);$(this).text(d[a]),TTLChart.selectedNets.pop(),TTLChart.update()}),$("[data-payload]").drag(function(a,b){TTLChart.payloadTarget=TTLChart.updateValue(a,b,TTLChart.payloadTarget,$(this).data("min"),$(this).data("max"),$(this).data("step")),$(this).text(TTLChart.payloadTarget),TTLChart.update()}),$("#delay-ack").click(function(){$(this).toggleClass("active"),TTLChart.modelGlobals.delayAck=!TTLChart.modelGlobals.delayAck,TTLChart.update()}),$("#networks .ui.dropdown").dropdown().dropdown("setting","onChange",function(a){TTLChart.addNetwork(a),TTLChart.updateView(),TTLChart.update()})},initLargePacket:function(){d3.text("data/largepacket.txt",function(a,b){var c=PacketManager.buildStats(b),d=PacketManager.encodeMarkup(b,!1);$("#data-text").html(d),$("#data-markup").html(c.markup),$("#data-content").html(c.content),$("#data-first").html(c.first)})}},PacketManager={buildStats:function(a){noSpace=a.replace(/  +/gm,"").replace(/\n/gm,"");var b=noSpace.length,c=noSpace.replace(/<[^>]+>/gm,"").length,d=noSpace.replace(/OK.*/gm,"").length;return{first:d,markup:b-c,content:c}},encodeMarkup:function(a,b){return b||(b={markup:1,space:1,linebreak:1}),a.replace(/ /gm,b.space?"&nbsp;":"").replace(/<([^>]+)>/gm,b.markup?"&lt;$1&gt;":"").replace(/gt;([^&]+)&lt;/gm,b.markup?'gt;<b style="color: red">$1</b>&lt;':"").replace(/$/gm,b.linebreak?'<br class="linebreak"/>':"")}},TTLChart={data:[],spec:{},chart:{},activeNet:"",selectedNets:[],modelGlobals:{delayAck:!0},chartUrl:"data/ttl-chart.json",payloadTarget:200,view:{menu:"#networks",properties:"#net-properties",payload:"#networks",summary:"#ttl-summary",chart:"#ttl-chart"},properties:{bw:{label:"Bandwidth (Mbps)",min:.5,max:1e3,step:.5},rtt:{label:"RTT (ms)",min:1,max:500,step:1},rwnd:{label:"Rwnd (kB)",min:4,max:512,step:1},cwnd:{label:"Cwnd (Packets)",min:2,max:16,step:1},mtu:{label:"MTU (B)",min:500,max:9e3,step:500}},netsTemplate:{adsl:{name:"ADSL",bw:10,rtt:30,rwnd:64,cwnd:3,mtu:1500,time:0},fibre:{name:"Fibre",bw:100,rtt:20,rwnd:64,cwnd:3,mtu:1500,time:0},ethernet:{name:"Ethernet",bw:1e3,rtt:1,rwnd:64,cwnd:3,mtu:1500,time:0},mobile:{name:"Mobile",bw:3,rtt:150,rwnd:64,cwnd:3,mtu:1500,time:0}},update:function(){TTLChart.updateModel(),TTLChart.chart.data(TTLChart.data).update()},addNetwork:function(a){var b=a+TTLChart.selectedNets.length,c={id:b};for(var d in TTLChart.netsTemplate[a])c[d]=TTLChart.netsTemplate[a][d];TTLChart.selectedNets.push(c),TTLChart.activeNet=TTLChart.selectedNets.length-1},updateView:function(){$(".item[data-net]",TTLChart.view.menu).unbind().remove();for(var a in TTLChart.selectedNets){var b=TTLChart.selectedNets.length-1-a,c=TTLChart.selectedNets[b];$(TTLChart.view.menu).prepend('<div data-net="'+b+'" class="item">'+c.name+'<div class="ui large color'+b+' label">'+c.time+" ms</div></div>")}$(".item[data-net]",TTLChart.view.menu).bind("click",function(){TTLChart.activeNet=$(this).data("net"),TTLChart.updateView()}),$('.item[data-net="'+TTLChart.activeNet+'"]',TTLChart.view.menu).addClass("active"),$("[data-payload]",TTLChart.view.payload).data("payload",TTLChart.payloadTarget).text(TTLChart.payloadTarget),$("[data-property]",TTLChart.view.properties).each(function(){var a=$(this).data("property"),b=TTLChart.properties[a];$(this).data("min",b.min),$(this).data("max",b.max),$(this).data("step",b.step),$(this).text(TTLChart.selectedNets[TTLChart.activeNet][a])}),$(TTLChart.view.properties).data("net",TTLChart.activeNet),TTLChart.updateSummary()},updateTime:function(a){$('.item[data-net="'+a+'"] .label',TTLChart.view.menu).text(Math.ceil(TTLChart.selectedNets[a].time)+" ms")},updateValue:function(a,b,c,d,e,f){var g=c+Math.floor(b.deltaX/5)*f;return Math.min(e,Math.max(d,g))},updateModel:function(){var a=[];for(var b in TTLChart.selectedNets){var c=TTLChart.selectedNets[b];c.target=TTLChart.payloadTarget,c.time=TTLChart.buildData(a,c),TTLChart.updateTime(b)}TTLChart.updateSummary(),TTLChart.data={ttl:a}},updateSummary:function(){TTLChart.view.summary&&($(TTLChart.view.summary).children().remove(),TTLChart.selectedNets.forEach(function(a){$(TTLChart.view.summary).append("<tr><td>"+a.name+"</td><td>"+a.bw+"</td><td>"+a.rtt+"</td><td>"+a.rwnd+" kB / "+a.cwnd+"</td><td>"+a.mtu+"</td><td>"+a.time+"</td><td>"+Math.ceil(8*a.target/a.time*1e5)/100+"</td></tr>"),$("#ttl-target").html(a.target)}))},buildData:function(a,b){var c=0,d=0,e=0,f=Math.min(b.cwnd,b.rwnd),g=f,h=0,i={},j={},k=0,l=b.id,m=b.mtu-40,n=Math.min(b.cwnd*m,14600);for(rwnd=1024*b.rwnd,latency=.5*b.rtt,tryIndicator=0,loop=0,target=b.target,ssmode=!0,l.indexOf("drag")+"drag".length==l.length&&(l=l.substring(0,l.length-4),tryIndicator=1);0==c&&1e4>loop;){var o=0;if(i[k]&&(n+=ssmode?TTLChart.modelGlobals.delayAck?i[k]/2:i[k]:m,e-=i[k]),f=Math.min(n,rwnd),g=Math.max(0,f-e),j[k]){var p=Math.ceil(j[k]/m)+h;if(TTLChart.modelGlobals.delayAck){var q=p%2;h=q,p-=q}i[k+latency]=Math.min(j[k],p*m),d+=j[k],d>=1024*target&&(c=1)}else j[k]=0;g>0&&(o=Math.min(2*latency*b.bw*1024/8,g),g>o&&(n=Math.floor(n/2),ssmode=!1),j[k+latency]=o,e+=o),k>0&&a.push({name:l,"try":tryIndicator,send:Math.max(0,k-latency),receive:k,bytes:j[k],done:0}),k+=latency,loop++}return k}};